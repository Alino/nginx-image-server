proxy_cache_path /var/www/nginx/cache levels=1:2 keys_zone=cache-space:4m max_size=50m inactive=120m;
proxy_temp_path /var/www/nginx/tmp;

server {
  listen 80;
  root /var/www/nginx;

  server_name $server_name_from_env;

  location /favicon.ico {
    access_log off;
  }

  location @empty {
    empty_gif;
  }

  location ~ small_light[^/]*/(.+)$ {
    proxy_pass http://localhost:8080;
    proxy_cache cache-space;
    proxy_cache_valid 200 60m;
  }

  location /assets {
    proxy_pass http://localhost:8080;
    proxy_cache_valid 200 60m;
  }

  location /news_assets {
    proxy_pass http://localhost:8080;
    proxy_cache_valid 200 60m;
  }

  location /tmp {
    proxy_pass http://localhost:8080;
    proxy_cache_valid 200 60m;
  }
}

server {
  listen 8080;
  server_name $server_name_from_env;

  resolver 8.8.8.8;
  small_light on;

  location /favicon.ico {
    root /var/www/nginx;
    access_log off;
  }

  location @empty {
    empty_gif;
  }

  location ~ ^/(assets|tmp|news_assets)/(.*) {
    proxy_pass http://$s3_host_from_env/$1/$2;
    error_page 415 = @empty;
  }

  location ~ small_light[^/]*/(.+)$ {
    set $file $1;
    rewrite ^ /$file;
  }
}
